<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title> Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      margin-bottom: 15px;
      font-size: 26px;
      text-align: center;
    }
    h3 {
      margin-bottom: 10px;
      font-size: 18px;
    }
    .dashboard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .chart-card, .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }
    .stat-card {
      font-size: 16px;
      text-align: center;
    }
    .stat-card span {
      display: block;
      margin-top: 6px;
      font-size: 20px;
      font-weight: bold;
      color: #4e73df;
    }
    canvas {
      max-height: 280px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Analytics Dashboard</h1>

  <!-- Stats -->
  <div class="dashboard-container">
    <div class="stat-card" id="totalUsers">Total Users <span>--</span></div>
    <div class="stat-card" id="bounceRate">Bounce Rate <span>--</span></div>
    <div class="stat-card" id="avgSessionDuration">Avg. Duration <span>--</span></div>
    <div class="stat-card" id="engagedSessions">Engaged Sessions <span>--</span></div>
    <div class="stat-card" id="pagesPerSession">Pages/Session <span>--</span></div>
  </div>

  <!-- Main Charts -->
  <div class="dashboard-container">
    <div class="chart-card">
      <h3>Clicks by Page</h3>
      <canvas id="barChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>Device Types</h3>
      <canvas id="pieChart"></canvas>
    </div>
  </div>

  <!-- Funnel Chart -->
  <div class="dashboard-container">
    <div class="chart-card" style="grid-column: 1/-1;">
      <h3>Funnel Steps</h3>
      <canvas id="funnelChart"></canvas>
    </div>
  </div>

  <!-- Button Click Charts -->
  <div id="button-click-charts" class="dashboard-container"></div>

  <!-- CSV Export -->
  <div style="margin-top: 20px; text-align: center;">
    <button id="downloadCSV" style="padding: 10px 20px; font-size: 14px; background: #4e73df; color: white; border: none; border-radius: 6px; cursor: pointer;">
      Download CSV
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0SqV1AdhuXazfD2avca1kgpeY1lW4OO0",
      authDomain: "analytics-project-fdf38.firebaseapp.com",
      projectId: "analytics-project-fdf38",
      storageBucket: "analytics-project-fdf38.appspot.com",
      messagingSenderId: "859589794211",
      appId: "1:859589794211:web:bc4ff59ee2a6fe51e32216"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const eventsRef = collection(db, "events");

    async function renderDashboard() {
      const snapshot = await getDocs(eventsRef);

      const pageClicks = {};
      const devices = {};
      const sessions = {};
      const buttonClicks = {};
      let totalPages = 0, totalDuration = 0;

      snapshot.forEach(doc => {
  const data = doc.data();
  const sessionId = data.sessionId;

  // Map raw Firebase page to friendly name
  const pageMap = {
    "/": "Home",
    "/index.html": "Home",
    "/project.html": "Project Page",
    "/event-tracking-page.html": "Event Tracking Page"
  };
  const rawPage = data.page || data.currentPage ||  "Unknown";
  //const page = pageMap[rawPage] || rawPage.replace(/^\//, "");
let page;
if (pageMap[rawPage]) {
  page = pageMap[rawPage];
} else if (rawPage.startsWith("/")) {
  page = rawPage.substring(1);
} else {
  page = rawPage;
}

// ðŸš« Skip any unknown/empty page entirely
if (page === "Unknown" || !page.trim()) return;

const deviceType = data.deviceType || "Unknown";
const type = data.type;


  // Track sessions
  if (!sessions[sessionId]) sessions[sessionId] = { pages: 0, engaged: false, totalDuration: 0 };

  if (type === "time_on_page") {
    const durationMs = (data.duration_seconds || 0) * 1000;
    sessions[sessionId].totalDuration += durationMs;
    if (data.duration_seconds > 10) sessions[sessionId].engaged = true;
    totalDuration += durationMs;
    sessions[sessionId].pages++;
    totalPages++;
  }

  if (type === "click") {
    pageClicks[page] = (pageClicks[page] || 0) + 1;
    if (!buttonClicks[page]) buttonClicks[page] = {};

    // Map unknown labels to friendly names
  // Map unknown labels to friendly names
const labelMap = {
  "contact_us_button": "Contact Us",
  "buy_now_button": "Buy Now",
  "signup_button": "Sign Up"
};
const label = labelMap[data.label] || (data.label && data.label.trim() !== "" ? data.label : null);

// ðŸš« Skip adding clicks with unknown or empty labels
if (!label) return;

buttonClicks[page][label] = (buttonClicks[page][label] || 0) + 1;

}

  // Device tracking
  devices[deviceType] = (devices[deviceType] || 0) + 1;
});

      const uniqueUsers = new Set(Object.keys(sessions));
      const engagedSessions = Object.values(sessions).filter(s => s.engaged).length;
      const bounceRate = (Object.values(sessions).filter(s => s.pages === 1).length / uniqueUsers.size) * 100 || 0;
      const avgSessionDuration = totalDuration / uniqueUsers.size || 0;
      const pagesPerSession = totalPages / uniqueUsers.size || 0;

      document.getElementById("totalUsers").querySelector("span").textContent = uniqueUsers.size;
      document.getElementById("bounceRate").querySelector("span").textContent = bounceRate.toFixed(1) + "%";
      document.getElementById("avgSessionDuration").querySelector("span").textContent = (avgSessionDuration / 1000).toFixed(1) + "s";
      document.getElementById("engagedSessions").querySelector("span").textContent = engagedSessions;
      document.getElementById("pagesPerSession").querySelector("span").textContent = pagesPerSession.toFixed(2);

      renderMainCharts(pageClicks, devices);
      renderButtonCharts(buttonClicks);
      await renderButtonClickFunnel();

    }

    function renderMainCharts(pageClicks, devices) {
      new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {
          labels: Object.keys(pageClicks),
          datasets: [{ label: 'Clicks', data: Object.values(pageClicks), backgroundColor: '#4e73df' }]
        },
        options: { responsive: true }
      });
      new Chart(document.getElementById("pieChart"), {
        type: 'pie',
        data: {
          labels: Object.keys(devices),
          datasets: [{ data: Object.values(devices), backgroundColor: ['#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'] }]
        },
        options: { responsive: true }
      });
    }

    function renderButtonCharts(buttonClicks) {
      const container = document.getElementById("button-click-charts");
      container.innerHTML = "";
      Object.entries(buttonClicks).forEach(([page, buttons]) => {
        const card = document.createElement("div");
        card.className = "chart-card";
        card.innerHTML = `<h3>Button Clicks - ${page}</h3><canvas></canvas>`;
        container.appendChild(card);
        new Chart(card.querySelector("canvas"), {
          type: 'bar',
          data: {
            labels: Object.keys(buttons),
            datasets: [{ label: 'Clicks', data: Object.values(buttons), backgroundColor: '#ff6384' }]
          },
          options: { responsive: true }
        });
      });
    }

    async function renderButtonClickFunnel() {
  const snapshot = await getDocs(eventsRef);

  // Define funnel steps in order (update with your real button labels)
  const funnelSteps = [
    //"like_button",
   // "subscribe_button",
    "signup_button",
    "contact_us_button"
  ];

  // Count unique sessions for each step
  const stepCounts = funnelSteps.map(() => new Set());
  snapshot.forEach(doc => {
    const data = doc.data();
    if (data.type === "click" && data.label) {
      const stepIndex = funnelSteps.indexOf(data.label);
      if (stepIndex !== -1 && data.sessionId) {
        stepCounts[stepIndex].add(data.sessionId);
      }
    }
  });

  // Convert sets to counts
  const values = stepCounts.map(set => set.size);

  // Create a horizontal tapered funnel effect by scaling barThickness
  const maxValue = Math.max(...values);
  const barThicknesses = values.map(v => Math.max(10, (v / maxValue) * 60));

  // Render funnel chart
  new Chart(document.getElementById("funnelChart"), {
    type: 'bar',
    data: {
      labels: funnelSteps,
      datasets: [{
        label: 'Unique Sessions',
        data: values,
        backgroundColor: '#36b9cc',
        barThickness: ctx => barThicknesses[ctx.dataIndex] // taper effect
      }]
    },
    options: {
      indexAxis: 'y', // horizontal bars
      responsive: true,
      plugins: {
        tooltip: { callbacks: {
          label: ctx => `${ctx.parsed.x} sessions`
        }},
        legend: { display: false }
      },
      scales: {
        x: { beginAtZero: true },
        y: { reverse: true } // so funnel starts at top
      }
    }
  });
}



   document.getElementById("downloadCSV").addEventListener("click", async () => {
  const snapshot = await getDocs(eventsRef);
  let csv = "timestamp,sessionId,page,type,label,deviceType,duration_seconds\n";
  
  snapshot.forEach(doc => {
    const d = doc.data();
    
    // Format timestamp
    let formattedTime = "";
    if (d.timestamp?.toDate) {
      const dateObj = d.timestamp.toDate();
      formattedTime = dateObj.toLocaleString("en-IN", { 
        dateStyle: "short", 
        timeStyle: "medium" 
      });
    }

    csv += `${formattedTime},${d.sessionId || ""},${d.page || ""},${d.type || ""},${d.label || ""},${d.device?.deviceType || ""},${d.duration_seconds || ""}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `analytics_${new Date().toISOString().split("T")[0]}.csv`;
  link.click();
});
 

    renderDashboard();
  </script>
</body>
</html>
